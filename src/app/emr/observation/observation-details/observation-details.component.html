<p-growl [(value)]="msgs" life="1000"></p-growl>
<div class="emr-details">
  <div class="m-b10 ebg-white">
    <div class="head-text">
      <p class="col-sm-12 text-center w-85 pull-left m-0">Observation</p>
      <a class="pull-right" id="back_Observation" (click)="backToListing()">
        <button class="addbutton">
          <i class="fa fa-arrow-circle-left"></i>
        </button>
      </a>
    </div>
    <div class="legend-like-labels" [formGroup]="emrObservationdetailsForm">
      <div class="col-sm-4 pull-left m-b10 m-t10">
        <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">SourceType
          <span class="required">*</span>
        </label>
        <div class="col-sm-7 pull-left no-padd" [class.disabled]="isReadOnly">
          <select formControlName="SourceType" class="emr-dropdown">
            <option value=''>Select Source Type</option>
            <option *ngFor="let sType of observationSelectDropdown?.sourceTypes" [value]='sType.Id'>{{sType.Description}}</option>
          </select>
        </div>
      </div>
      <div class="col-sm-4 pull-left m-b10 m-t10">
        <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">SourceID</label>
        <div class="col-sm-7 pull-left no-padd">
          <input type="text" formControlName="SourceId" OnlyNumber="true" maxlength="3">
        </div>
      </div>
      <!-- Lab Information -->
      <div class="head-text subhead inline-block">
        <p class="normal pull-left m-0">Lab Details</p>
      </div>
      <div class="col-sm-12 no-padd">
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Performer</label>
          <div class="col-sm-7 pull-left no-padd">
            <input type="text" formControlName="Performer" maxlength="50" placeholder="Performer">
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Identifier</label>
          <div class="col-sm-7 pull-left no-padd">
            <input type="text" formControlName="Performer" maxlength="50" placeholder="Identifier">
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10 h-30">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Context</label>
          <div class="col-sm-7 pull-left no-padd">
            <a class="emr_link" (click)="encounterPage()">Link to encounter</a>
            <input type="text" formControlName="Context" maxlength="50" style="display:none">
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">BodySite</label>
          <div class="col-sm-7 pull-left no-padd" style="z-index: 999">
            <input type='text' (keyup)="searchDropDown(88, src7.value ,i)" #src7 formControlName="BodySite" [(ngModel)]="selectedBodySite"
              minlength="3" placeholder="Please key in(eg:a)"/>
            <div *ngIf="observationDropdown && observationDropdown?.bodySite && IsHidden " class="emr-dropdown">
              <ul *ngFor="let bodyType of observationDropdown?.bodySite" (click)="getValue(bodyType,i)" class="p-l10 m-b0 brd-b">
                <li>
                  {{bodyType.Description}}
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Device</label>
          <div class="col-sm-7 pull-left no-padd">
            <a class="emr_link" (click)="devicePage()">Link to devices</a>
            <input type="text" formControlName="Device" style="display:none">
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Code
            <span class="required">*</span>
          </label>
          <div class="col-sm-7 pull-left no-padd">
            <input type='text' (keyup)="searchDropDown(85, src3.value ,i)" #src3 formControlName="Code" [(ngModel)]="selectedCode" minlength="3"
            placeholder="Please key in(eg:a)" />
            <div *ngIf="observationDropdown && observationDropdown?.code && IsHidden" class="emr-dropdown">
              <ul *ngFor="let codeType of observationDropdown?.code" (click)="getValue(codeType,i)" class="p-l10 m-b0 brd-b">
                <li>
                  {{codeType.Description}}
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Category
            <span class="required">*</span>
          </label>
          <div class="col-sm-7 pull-left no-padd">
            <select formControlName="Category" class="emr-dropdown">
              <option value=''>Select Category</option>
              <option *ngFor="let categoryType of observationSelectDropdown?.category" [value]='categoryType.Id'>{{categoryType.Description}}</option>
            </select>
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Method</label>
          <div class="col-sm-7 pull-left no-padd">
            <input type='text' (keyup)="searchDropDown(89, src1.value ,i)" #src1 formControlName="Method" [(ngModel)]="selectedMethod" minlength="3"
            placeholder="Please key in(eg:a)" />
            <div *ngIf="observationDropdown && observationDropdown?.method && IsHidden" class="emr-dropdown">
              <ul *ngFor="let mType of observationDropdown?.method" (click)="getValue(mType,i)" class="p-l10 m-b0 brd-b">
                <li>
                  {{mType.Description}}
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd" style="z-index:1">Issued On</label>
          <div class="col-sm-7 pull-left no-padd">
            <p-calendar id="date1" formControlName="Issued" [monthNavigator]="true" [yearNavigator]="true" yearRange="1910:2020" showButtonBar="true"
             dateFormat="mm-dd-yy" placeholder="mm-dd-yyyy" [maxDate]="dateTime" [showIcon]="true"></p-calendar>
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Status
            <span class="required">*</span>
          </label>
          <div class="col-sm-7 pull-left no-padd">
            <select formControlName="Status" class="emr-dropdown">
              <option value=''>Select Status</option>
              <option *ngFor="let statusType of observationSelectDropdown?.status" [value]='statusType.Id'>{{statusType.Description}}</option>
            </select>
          </div>
        </div>
        <div class="col-sm-4 pull-left m-b10 m-t10">
          <label class="col-sm-5 pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Interpretation</label>
          <div class="col-sm-7 pull-left no-padd">
            <input type='text' (keyup)="searchDropDown(87, src5.value ,i)" #src5 formControlName="Interpretation" [(ngModel)]="selectedInterpretation"
              minlength="3" placeholder="Please key in(eg:a)"/>
            <div *ngIf="observationDropdown && observationDropdown?.interpretation && IsHidden" class="emr-dropdown">
              <ul *ngFor="let iType of observationDropdown?.interpretation" (click)="getValue(iType,i)" class="p-l10 m-b0 brd-b">
                <li>
                  {{iType.Description}}
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Effective - Clinically relevant time/time-period  observation -->
      <div class="head-text subhead inline-block">
        <p class="normal pull-left m-0">Effective - Clinically relevant time/time-period observation</p>
        <div class="btnPlus no-padd pull-left" [class.disabled]="emrObservationdetailsForm.get('Effectivex').controls.length > 4" >
          <button class="text-right pull-right add_effective" (click)="addDatePeriod()" [disabled]="!encounterlink">
            <i id="add" class="fa fa-plus"></i>
          </button>
        </div>
      </div>
<div class="col-sm-12 m-t10">

      <table class="table table-bordered time-period">
        <thead>
          <tr>
            <th>DateTime</th>
            <th>Period</th>
            <th></th>
          </tr>
        </thead>
        <div colspan="2" class="col-sm-12 m-t10 contents" formArrayName="Effectivex">
          <tbody *ngFor="let itemrow of emrObservationdetailsForm.get('Effectivex').controls;let i = index;" [formGroupName]="i">
            <tr>
              <td>
                <p-calendar formControlName="EffectiveDateTime" [monthNavigator]="true" [yearNavigator]="true" yearRange="1910:2020" showButtonBar="true"
                  dateFormat="mm-dd-yy" placeholder="mm-dd-yyyy" [showIcon]="true" [minDate]="yesterday"></p-calendar>
              </td>
              <td>
                <input type="text" formControlName="EffectivePeriod" maxlength="2" OnlyNumber="true" placeholder="Period in number">
              </td>
              <td>
                <div class="pull-left m-b10 ">
                  <a class="col-sm-2 pull-left m-b10 m-t10 delbtn" *ngIf="emrObservationdetailsForm.get('Effectivex').controls.length >1" (click)="deleteDetails(i)">
                    <i class="fa fa-trash trash"></i>
                  </a>
                </div>
              </td>
            </tr>
          </tbody>
        </div>
      </table>

    </div>

      <!-- Actual Results -->
      <div class="head-text subhead inline-block">
        <p class="normal pull-left m-0">Actual Results</p>
        <div class="btnPlus no-padd pull-left" [class.disabled]="emrObservationdetailsForm.get('ValuexV').controls.length > 4" style="left:84%">
          <button class="text-right pull-right add_effective" (click)="addValue()" [disabled]="!encounterlink">
            <i id="add" class="fa fa-plus"></i>
          </button>
        </div>
      </div>
      <div class="col-sm-12 m-t10">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Value String</th>
              <th>Quantity</th>
              <th>Range</th>
            </tr>
          </thead>
          <div colspan="3" class="col-sm-12 m-t10 contents" formArrayName="ValuexV">
            <tbody *ngFor="let itemrow of emrObservationdetailsForm.get('ValuexV').controls;let i = index;" [formGroupName]="i">
              <tr>
                <td>
                  <input type="text" formControlName="ValueString" maxlength="50" placeholder="String">
                </td>
                <td>
                  <input type="text" formControlName="ValueQuantity" maxlength="2" OnlyNumber="true" placeholder="Quantity in Number">
                </td>
                <td>
                  <input type="text" formControlName="ValueRange" maxlength="2" placeholder="Range in Number" OnlyNumber="true">
                </td>
                <td>
                  <div class="col-sm-4 pull-left m-b10">
                    <a class="col-sm-2 pull-left m-b10 m-t10 delbtn" *ngIf="emrObservationdetailsForm.get('ValuexV').controls.length >1" (click)="deleteValue(i)">
                      <i class="fa fa-trash trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
            </tbody>
          </div>
        </table>
      </div>

      <!-- Component Results -->
      <div class="head-text subhead inline-block">
        <p class="normal pull-left m-0">Component Results</p>
        <div class="btnPlus no-padd pull-left" [class.disabled]="emrObservationdetailsForm.get('ComponentC').controls.length > 4" style="left:79%">
          <button class="text-right pull-right add_effective" (click)="addComponent()" [disabled]="!encounterlink">
            <i id="add" class="fa fa-plus"></i>
          </button>
        </div>
      </div>
      <div class="col-sm-12 m-t10">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Code</th>
              <th>Absent Reason</th>
              <th>Interpretation</th>
            </tr>
          </thead>
          <div colspan="3" class="col-sm-12 m-t10 contents" formArrayName="ComponentC">
            <tbody *ngFor="let itemrow of emrObservationdetailsForm.get('ComponentC').controls;let i = index;" [formGroupName]="i">
              <tr>
                <td>
                  <input type='text' (keyup)="searchDropDown(94, src10.value ,i)" #src10 formControlName="CCode"
                    minlength="3" placeholder="Please key in(eg:a)"/>
                  <div *ngIf="observationDropdown && observationDropdown?.compCode && IsHidden && contactIndex == i " class="emr-dropdown">
                    <ul *ngFor="let ccType of observationDropdown?.compCode" (click)="getValue(ccType, i)" class="p-l10 m-b0 brd-b">
                      <li>
                        {{ccType.Description}}
                      </li>
                    </ul>
                  </div>
                </td>
                <td>
                  <select formControlName="DataAbsentReason" class="emr-dropdown relative">
                    <option value=''>Select Absent Reason</option>
                    <option *ngFor="let dataType of observationSelectDropdown?.dataAbsentReason" [value]='dataType.Id'>{{dataType.Description}}</option>
                  </select>
                  <!-- <input type="text" formControlName="DataAbsentReason" maxlength="50" placeholder="Absent Reason"> -->
                </td>
                <td>
                  <input type="text" formControlName="Interpret" maxlength="50" placeholder="Interpretation">
                </td>
                <td>
                  <div class="col-sm-4 pull-left m-b10">
                    <a class="col-sm-2 pull-left m-b10 m-t10 delbtn" *ngIf="emrObservationdetailsForm.get('ComponentC').controls.length >1" (click)="deleteComponent(i)">
                      <i class="fa fa-trash trash"></i>
                    </a>
                  </div>
                </td>
              </tr>
            </tbody>
          </div>
        </table>
      </div>

      <!-- Notes -->
      <div class="head-text subhead inline-block">
        <p class="normal pull-left m-0">Notes</p>
      </div>
      <div class="col-sm-12 no-padd">
        <div class="col-sm-12 pull-left m-b10 m-t10">
          <label class="lbl_note pull-left col-form-label g-color-gray-dark-v2 text-sm-left no-padd">Comment</label>
          <div class="txt_note pull-left no-padd">
            <input type="text" formControlName="Comment" maxlength="100">
          </div>
        </div>
      </div>
    </div>
    <!-- Encounter Screen -->
    <p-dialog header="Link to Encounter" [(visible)]="encounterScreen" [responsive]="true" showEffect="fade" [modal]="true" [width]="800">
      <p-table #dt [columns]="tableHeaders" [value]="emrEncounterLists">
        <ng-template pTemplate="header" let-columns>
          <tr role="row">
            <th>
              <input type="checkbox" [(ngModel)]="selectedAllEncounter" (change)="selectAllEncounter()" [disabled]="!encounterlink">
            </th>
            <th>Period From</th>
            <th>Period To</th>
            <th>Priority</th>
            <th>Type</th>
            <th>Service Provider</th>
            <th>Status</th>
          </tr>

        </ng-template>
        <ng-template pTemplate="body" let-rowData let-columns="columns" let-i="rowIndex">
          <tr [pSelectableRow]="rowData">
            <td>
              <input type="checkbox" [(ngModel)]="rowData.selected" (change)="checkIfAllEncounterSelected()" [disabled]="!encounterlink"> </td>
            <td>{{rowData.PeriodStart |date:'MM/dd/yyyy'}}</td>
            <td>{{rowData.PeriodEnd |date:'MM/dd/yyyy'}}</td>
            <td>{{rowData.Priority}}</td>
            <td>{{rowData.TypeDesc}}</td>
            <td>{{rowData.ServiceProvider}}</td>
            <td>{{rowData.StatusDesc}}</td>
          </tr>
        </ng-template>
      </p-table>
      <p-footer>
        <div class="ui-dialog-buttonpane ui-helper-clearfix popup" *ngIf="observationDetails?.mode !== 'readOnly'">
          <button class="btn btn-primary clr-white m-b10" type="button" (click)="saveEncounterScreen()" [disabled]="!encounterlink">Save</button>
        </div>
      </p-footer>
    </p-dialog>
    <!-- Device Screen -->
    <p-dialog header="Link to Device" [(visible)]="deviceScreen" [responsive]="true" showEffect="fade" [modal]="true" [width]="800">
        <p-table #dt [columns]="tableHeaders" [value]="listEmrDevice">
          <ng-template pTemplate="header" let-columns>
            <tr role="row">
              <th>
                <input type="checkbox" [(ngModel)]="selectedAll" (change)="selectAll()" [disabled]="!devicelink">
              </th>
              <th>Owner</th>
              <th>Device Name</th>
              <th>Device Identifier</th>
              <th>Status</th>
            </tr>
  
          </ng-template>
          <ng-template pTemplate="body" let-rowData let-columns="columns" let-i="rowIndex">
            <tr [pSelectableRow]="rowData">
              <td>
                <input type="checkbox" [(ngModel)]="rowData.selected" (change)="checkIfAllSelected()" [disabled]="!devicelink"> </td>
              <td>{{rowData.Owner}}</td>
              <td>{{rowData.Udi.Name}}</td>
              <td>{{rowData.Udi.DeviceIdentifier}}</td>
              <td>{{rowData.StatusDesc}}</td>
            </tr>
          </ng-template>
        </p-table>
        <p-footer>
          <div class="ui-dialog-buttonpane ui-helper-clearfix popup" *ngIf="observationDetails?.mode !== 'readOnly'">
            <button class="btn btn-primary clr-white m-b10" type="button" (click)="saveDeviceScreen()" [disabled]="!devicelink">Save</button>
          </div>
        </p-footer>
      </p-dialog>

    <div class="col-sm-12 text-right m-b10 inline-block" *ngIf="observationDetails?.mode !== 'readOnly'">
      <button class="btn btn-primary clr-white m-b10" [disabled]="!emrObservationdetailsForm.valid" (click)="!observationDetails ? saveEmrObservation() : updateEmrObservation()">{{!observationDetails ? 'Save' : 'Update'}}</button>
    </div>
  </div>
</div>